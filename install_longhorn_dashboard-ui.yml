# üì¶ Instalaci√≥n completa de Longhorn con seguridad y exposici√≥n interna
- name: üöÄ Instalar y configurar Longhorn con Ingress y autenticaci√≥n
  hosts: localhost
  gather_facts: false
  vars_files:
    - vars/main.yml

  pre_tasks:
    - name: ‚úÖ Validar que kubeconfig_path est√© definido
      assert:
        that: kubeconfig_path is defined
        msg: "‚ùå kubeconfig_path no est√° definido en vars/main.yml"

# üß© Importar playbooks principales (deben tener sus propios hosts y tasks)
- import_playbook: playbooks/01_generate-auth-secret.yml
- import_playbook: playbooks/02_ingress-longhorn-internal.yml

# üåê Otras tareas previas a la verificaci√≥n del Dashboard
- name: üîç Verificar si el IngressRoute est√° correctamente aplicado
  shell: >
    {{ kubectl_path }} get ingressroute ingressroute-longhorn-internal -n {{ longhorn_namespace | default("longhorn-system") }} --kubeconfig {{ kubeconfig_path }}
  register: ingress_check
  changed_when: false

- name: üßæ Mostrar el estado del IngressRoute
  debug:
    msg: "Estado del IngressRoute: {{ ingress_check.stdout }}"

# üåê Verificaci√≥n tolerante de acceso al dashboard (se mueve al final)
- name: üåê Verificar acceso al Dashboard (modo tolerante)
  shell: >
    curl --http1.1 -k -u {{ longhorn_auth_user }}:{{ longhorn_auth_pass }}
    https://{{ domain }}/dashboard/
    --max-time 10 --silent --output /dev/null --write-out '%{http_code}'
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: dashboard_access_check
  retries: 5  # N√∫mero de reintentos
  delay: 10  # Retardo entre los intentos (en segundos)
  changed_when: false
  failed_when: dashboard_access_check.stdout is defined and
    dashboard_access_check.stdout not in ["200", "302", "401"]

- name: üõ†Ô∏è Depuraci√≥n de acceso al dashboard
  debug:
    msg: "C√≥digo HTTP recibido del dashboard: {{ dashboard_access_check.stdout }}"

- name: ‚ùå Fallar si no se puede acceder al dashboard despu√©s de los reintentos
  fail:
    msg: "El acceso al dashboard fall√≥ despu√©s de 5 intentos. C√≥digo HTTP: {{ dashboard_access_check.stdout }}"
  when: dashboard_access_check.stdout not in ["200", "302", "401"]
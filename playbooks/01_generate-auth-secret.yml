# playbooks/01_generate-auth-secret.yml
---
- hosts: localhost
  tasks:
    - name: âœ… Verificar que kubeseal estÃ¡ instalado
      stat:
        path: "{{ kubeseal_path }}"
      register: kubeseal_check

    - name: âŒ Abortamos si kubeseal no estÃ¡ instalado
      fail:
        msg: "kubeseal no encontrado en {{ kubeseal_path }}"
      when: not kubeseal_check.stat.exists

    - name: âœ… Verificar que kubectl estÃ¡ instalado
      stat:
        path: "{{ kubectl_path }}"
      register: kubectl_check

    - name: âŒ Abortamos si kubectl no estÃ¡ instalado
      fail:
        msg: "kubectl no encontrado en {{ kubectl_path }}"
      when: not kubectl_check.stat.exists

    - name: ğŸ“ Crear directorio local para secrets si no existe
      file:
        path: "{{ files_dir }}"
        state: directory
        mode: "0755"

    - name: ğŸ” Generar hash htpasswd (basicAuth con MD5)
      command: >
        {{ python_bin }} -c "import crypt; print('{{ longhorn_auth_user }}:' + crypt.crypt('{{ longhorn_auth_pass }}', crypt.mksalt(crypt.METHOD_MD5)))"
      register: htpasswd_output
      changed_when: true
      failed_when: htpasswd_output.rc != 0 or htpasswd_output.stdout == ""

    - name: ğŸ” Codificar el hash en base64
      set_fact:
        htpasswd_b64: "{{ htpasswd_output.stdout | b64encode }}"
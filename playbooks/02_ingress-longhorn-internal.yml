# playbooks/02_ingress-longhorn-internal.yml
# ðŸšª 2 - Exponer Longhorn Dashboard con IngressRoute Interno y AutenticaciÃ³n

- name: ðŸšª 2 - Exponer Longhorn Dashboard con IngressRoute Interno y AutenticaciÃ³n
  hosts: localhost
  become: false
  gather_facts: false

  vars_files:
    - ../vars/main.yml

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    kubectl_path: "/usr/local/bin/kubectl"
    files_dir: "{{ playbook_dir }}/files"
    rendered_auth_middleware_path: "{{ files_dir }}/longhorn-dashboard-auth.yaml"
    rendered_strip_middleware_path: "{{ files_dir }}/strip-prefix-dashboard.yaml"
    rendered_ingressroute_path: "{{ files_dir }}/longhorn-dashboard-ingressroute.yaml"

  tasks:
    - name: ðŸ“„ Renderizar Middleware de autenticaciÃ³n
      template:
        src: ../templates/longhorn/longhorn-dashboard-auth-middleware.yaml.j2
        dest: "{{ rendered_auth_middleware_path }}"

    - name: ðŸ“„ Renderizar Middleware de stripPrefix
      template:
        src: ../templates/longhorn/strip-prefix-dashboard-middleware.yaml.j2
        dest: "{{ rendered_strip_middleware_path }}"

    - name: ðŸ“„ Renderizar IngressRoute para el Dashboard
      template:
        src: ../templates/longhorn/longhorn-dashboard-ingressroute-internal.yaml.j2
        dest: "{{ rendered_ingressroute_path }}"

    - name: ðŸš€ Mostrar diff del Middleware (auth) (modo check)
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} diff -f "{{ rendered_auth_middleware_path }}"
      when: ansible_check_mode

    - name: ðŸš€ Aplicar Middleware (auth)
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply --validate=false -f "{{ rendered_auth_middleware_path }}"
      when: not ansible_check_mode

    - name: ðŸš€ Mostrar diff del Middleware (stripPrefix) (modo check)
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} diff -f "{{ rendered_strip_middleware_path }}"
      when: ansible_check_mode

    - name: ðŸš€ Aplicar Middleware (stripPrefix)
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply --validate=false -f "{{ rendered_strip_middleware_path }}"
      when: not ansible_check_mode

    - name: ðŸš€ Mostrar diff del IngressRoute (modo check)
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} diff -f "{{ rendered_ingressroute_path }}"
      when: ansible_check_mode

    - name: ðŸš€ Aplicar IngressRoute
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply --validate=false -f "{{ rendered_ingressroute_path }}"
      when: not ansible_check_mode
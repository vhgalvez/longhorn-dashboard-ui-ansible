# playbooks/02_ingress-longhorn-internal.yml
# ðŸšª 2 - Exponer Longhorn Dashboard con IngressRoute Interno y AutenticaciÃ³n

- name: ðŸšª 2 - Exponer Longhorn Dashboard con IngressRoute Interno y AutenticaciÃ³n
  hosts: localhost
  become: false
  gather_facts: false

  vars_files:
    - ../vars/main.yml

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    kubeseal_path: "/usr/local/bin/kubeseal"
    kubectl_path: "/usr/local/bin/kubectl"
    python_bin: "/usr/bin/python3"
    files_dir: "{{ playbook_dir }}/files"
    rendered_secret_path: "{{ files_dir }}/longhorn-dashboard-secret.yaml"
    sealed_secret_path: "{{ files_dir }}/longhorn-dashboard-sealed.yaml"

  tasks:
    - name: ðŸ“„ Renderizar Middleware de autenticaciÃ³n
      template:
        src: templates/longhorn/longhorn-dashboard-auth-middleware.yaml.j2
        dest: "{{ files_dir }}/longhorn-dashboard-auth.yaml"

    - name: ðŸ“„ Renderizar IngressRoute para el Dashboard
      template:
        src: templates/longhorn/longhorn-dashboard-ingressroute-internal.yaml.j2
        dest: "{{ files_dir }}/longhorn-dashboard-ingressroute.yaml"

    - name: ðŸš€ Mostrar diff del Middleware (modo check)
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} diff -f "{{ files_dir }}/longhorn-dashboard-auth.yaml"
      when: ansible_check_mode

    - name: ðŸš€ Aplicar Middleware (auth)
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply --validate=false -f "{{ files_dir }}/longhorn-dashboard-auth.yaml"
      when: not ansible_check_mode

    - name: ðŸš€ Mostrar diff del IngressRoute (modo check)
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} diff -f "{{ files_dir }}/longhorn-dashboard-ingressroute.yaml"
      when: ansible_check_mode

    - name: ðŸš€ Aplicar IngressRoute
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply --validate=false -f "{{ files_dir }}/longhorn-dashboard-ingressroute.yaml"
      when: not ansible_check_mode